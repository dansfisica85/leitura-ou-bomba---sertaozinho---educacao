<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitura ou Bomba</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí£</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 900px;
            width: 100%;
            text-align: center;
            position: relative;
            z-index: 10;
        }

        h1 {
            color: #e74c3c;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        /* V√≠deo no cabe√ßalho */
        .video-header {
            width: 100%;
            max-width: 180px;
            margin: 0 auto 15px auto;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
            border: 3px solid #e74c3c;
        }

        .video-header video {
            width: 100%;
            height: auto;
            display: block;
        }

        /* Overlay para explos√£o em tela cheia */
        .explosion-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .explosion-overlay.active {
            display: flex;
        }

        .explosion-overlay video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Tela de Cadastro */
        .register-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
        }

        .register-screen input {
            padding: 15px 25px;
            font-size: 1.2em;
            border: 3px solid #e74c3c;
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            outline: none;
            transition: all 0.3s;
        }

        .register-screen input:focus {
            border-color: #c0392b;
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.4);
        }

        /* Bot√£o INICIAR */
        .start-btn {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border: none;
            color: white;
            font-size: 1.8em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.5);
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
        }

        .start-btn::before {
            content: 'üí£';
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2em;
        }

        .start-btn span {
            position: relative;
            top: 30px;
        }

        .start-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(231, 76, 60, 0.6);
        }

        .start-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Contagem Regressiva */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .countdown-number {
            font-size: 15em;
            color: #e74c3c;
            font-weight: bold;
            animation: countdownPulse 1s ease-in-out;
            text-shadow: 0 0 50px rgba(231, 76, 60, 0.8);
        }

        @keyframes countdownPulse {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Cron√¥metro */
        .timer-display {
            font-size: 3.5em;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
        }

        .timer-display.warning {
            color: #f39c12;
        }

        .timer-display.danger {
            color: #c0392b;
            animation: blink 0.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Barra de progresso da palavra (3 segundos) */
        .word-timer-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .word-timer-progress {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #f39c12, #e74c3c);
            width: 100%;
            transition: width 0.1s linear;
        }

        /* √Årea do Jogo */
        .game-screen {
            display: none;
        }

        .word-display {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 50px 40px;
            border-radius: 15px;
            text-align: center;
            font-size: clamp(2.2rem, 6vw, 4.5rem);
            line-height: 1.15;
            font-weight: bold;
            margin-bottom: 20px;
            min-height: 220px;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 2px;
            text-transform: uppercase;
            word-break: break-word;
            white-space: pre-wrap;
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.4);
        }

        /* Indicador de Grava√ß√£o */
        .recording-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #e74c3c;
        }

        .recording-dot {
            width: 18px;
            height: 18px;
            background: #e74c3c;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.3); }
        }

        .result {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.1em;
            font-weight: 600;
        }

        .result.success {
            background: #d5f4e6;
            color: #1e8449;
            border: 2px solid #27ae60;
        }

        .result.error {
            background: #fadbd8;
            color: #922b21;
            border: 2px solid #e74c3c;
        }
        
        .result.interim {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
            animation: pulse 0.5s infinite alternate;
        }
        
        @keyframes pulse {
            from { opacity: 0.7; }
            to { opacity: 1; }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #ecf0f1;
        }

        .stat-value {
            font-size: 2.2em;
            font-weight: bold;
            color: #e74c3c;
        }

        .stat-label {
            color: #7f8c8d;
            margin-top: 5px;
            font-size: 0.85em;
        }

        .hidden {
            display: none !important;
        }

        /* Meta de 10 palavras */
        .goal-indicator {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1.1em;
            margin-bottom: 15px;
            display: inline-block;
        }

        .goal-indicator.achieved {
            background: linear-gradient(135deg, #27ae60, #1e8449);
        }

        /* Tela de Resultados */
        .results-screen {
            display: none;
        }

        .final-score {
            font-size: 4em;
            font-weight: bold;
            margin: 20px 0;
        }

        .final-score.success {
            color: #27ae60;
        }

        .final-score.fail {
            color: #e74c3c;
        }

        .time-display {
            font-size: 1.5em;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .ranking-title {
            font-size: 1.8em;
            color: #e74c3c;
            margin: 30px 0 20px 0;
        }

        .ranking-list {
            list-style: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #e74c3c;
        }

        .ranking-item.gold {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border-left-color: #f39c12;
        }

        .ranking-item.silver {
            background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%);
            border-left-color: #95a5a6;
        }

        .ranking-item.bronze {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-left-color: #e67e22;
        }

        .ranking-position {
            font-size: 1.4em;
            font-weight: bold;
            color: #e74c3c;
            min-width: 40px;
        }

        .ranking-name {
            flex: 1;
            text-align: left;
            margin-left: 15px;
            font-size: 1.1em;
        }

        .ranking-info {
            text-align: right;
        }

        .ranking-score {
            font-weight: bold;
            font-size: 1.2em;
            color: #27ae60;
        }

        .ranking-time {
            font-size: 0.85em;
            color: #7f8c8d;
        }

        .btn-restart {
            padding: 15px 40px;
            font-size: 1.2em;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }

        .btn-restart:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .user-greeting {
            font-size: 1.2em;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        /* Rodap√© */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.98);
            padding: 12px 20px;
            text-align: center;
            font-size: 0.8em;
            color: #7f8c8d;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .footer p {
            margin: 2px 0;
        }

        .footer .author {
            font-weight: bold;
            color: #e74c3c;
        }

        .footer .usage {
            color: #27ae60;
            font-weight: 600;
        }

        .container {
            margin-bottom: 100px;
        }

        /* Bot√£o de reset discreto */
        .reset-btn {
            background: transparent;
            border: none;
            color: #bdc3c7;
            font-size: 0.7em;
            cursor: pointer;
            padding: 5px 10px;
            margin-top: 3px;
            transition: color 0.3s;
        }

        .reset-btn:hover {
            color: #7f8c8d;
        }

        /* Modal de senha */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1001;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 350px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-content h3 {
            color: #e74c3c;
            margin-bottom: 20px;
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 1em;
            margin-bottom: 15px;
            box-sizing: border-box;
        }

        .modal-content input:focus {
            outline: none;
            border-color: #e74c3c;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            transition: transform 0.2s;
        }

        .modal-btn:hover {
            transform: scale(1.05);
        }

        .modal-btn.confirm {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .modal-btn.cancel {
            background: #ecf0f1;
            color: #7f8c8d;
        }

        .modal-error {
            color: #e74c3c;
            font-size: 0.85em;
            margin-top: 10px;
            display: none;
        }

        /* ===== RESPONSIVIDADE ===== */
        
        /* Tablets e telas m√©dias */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 25px 20px;
                border-radius: 15px;
                margin-bottom: 90px;
            }

            h1 {
                font-size: 1.8em;
                margin-bottom: 8px;
            }

            .video-header {
                max-width: 140px;
                margin-bottom: 10px;
            }

            .start-btn {
                width: 160px;
                height: 160px;
                font-size: 1.4em;
            }

            .start-btn::before {
                font-size: 1.6em;
                top: 15px;
            }

            .start-btn span {
                top: 25px;
            }

            .register-screen input {
                padding: 12px 20px;
                font-size: 1em;
            }

            .countdown-number {
                font-size: 10em;
            }

            .timer-display {
                font-size: 2.5em;
                margin-bottom: 15px;
            }

            .word-display {
                font-size: clamp(1.8rem, 5.5vw, 2.5rem);
                padding: 35px 25px;
                min-height: 150px;
                letter-spacing: 2px;
            }

            .goal-indicator {
                font-size: 0.95em;
                padding: 8px 15px;
            }

            .recording-indicator {
                font-size: 1em;
            }

            .recording-dot {
                width: 14px;
                height: 14px;
            }

            .stats {
                gap: 8px;
            }

            .stat-card {
                padding: 10px 8px;
            }

            .stat-value {
                font-size: 1.8em;
            }

            .stat-label {
                font-size: 0.75em;
            }

            .final-score {
                font-size: 3em;
            }

            .ranking-title {
                font-size: 1.4em;
                margin: 20px 0 15px 0;
            }

            .ranking-item {
                padding: 10px 12px;
            }

            .ranking-position {
                font-size: 1.2em;
                min-width: 35px;
            }

            .ranking-name {
                font-size: 0.95em;
                margin-left: 10px;
            }

            .ranking-score {
                font-size: 1em;
            }

            .btn-restart {
                padding: 12px 30px;
                font-size: 1em;
            }

            .footer {
                padding: 10px 15px;
                font-size: 0.7em;
            }
        }

        /* Smartphones */
        @media screen and (max-width: 480px) {
            body {
                padding: 5px;
                align-items: flex-start;
                padding-top: 10px;
            }

            .container {
                padding: 20px 15px;
                border-radius: 12px;
                margin-bottom: 85px;
            }

            h1 {
                font-size: 1.5em;
                margin-bottom: 5px;
            }

            .video-header {
                max-width: 120px;
                border-width: 2px;
                border-radius: 8px;
                margin-bottom: 8px;
            }

            .start-btn {
                width: 140px;
                height: 140px;
                font-size: 1.2em;
                letter-spacing: 1px;
            }

            .start-btn::before {
                font-size: 1.4em;
                top: 12px;
            }

            .start-btn span {
                top: 22px;
            }

            .register-screen {
                gap: 18px;
            }

            .register-screen input {
                padding: 10px 15px;
                font-size: 0.95em;
                border-width: 2px;
            }

            .register-screen p {
                font-size: 0.9em !important;
            }

            .countdown-number {
                font-size: 7em;
            }

            .timer-display {
                font-size: 2em;
                margin-bottom: 10px;
            }

            .word-display {
                font-size: clamp(1.4rem, 6.5vw, 2.1rem);
                padding: 25px 15px;
                min-height: 140px;
                letter-spacing: 1px;
                line-height: 1.2;
                word-break: break-word;
                white-space: pre-wrap;
                border-radius: 10px;
                margin-bottom: 12px;
            }

            .word-timer-bar {
                height: 6px;
                margin-bottom: 10px;
            }

            .goal-indicator {
                font-size: 0.85em;
                padding: 6px 12px;
                margin-bottom: 10px;
            }

            .recording-indicator {
                font-size: 0.85em;
                gap: 6px;
                margin-bottom: 10px;
            }

            .recording-dot {
                width: 12px;
                height: 12px;
            }

            .result {
                padding: 8px;
                font-size: 0.95em;
                margin-bottom: 10px;
            }

            .stats {
                gap: 6px;
                margin-top: 10px;
            }

            .stat-card {
                padding: 8px 5px;
                border-radius: 8px;
            }

            .stat-value {
                font-size: 1.5em;
            }

            .stat-label {
                font-size: 0.65em;
                margin-top: 3px;
            }

            .user-greeting {
                font-size: 1em;
                margin-bottom: 8px;
            }

            .final-score {
                font-size: 2.5em;
                margin: 15px 0;
            }

            .time-display {
                font-size: 1.2em;
            }

            .ranking-title {
                font-size: 1.2em;
                margin: 15px 0 10px 0;
            }

            .ranking-list {
                max-height: 200px;
            }

            .ranking-item {
                padding: 8px 10px;
                margin: 6px 0;
                border-radius: 8px;
            }

            .ranking-position {
                font-size: 1em;
                min-width: 30px;
            }

            .ranking-name {
                font-size: 0.85em;
                margin-left: 8px;
            }

            .ranking-info {
                min-width: 60px;
            }

            .ranking-score {
                font-size: 0.9em;
            }

            .ranking-time {
                font-size: 0.7em;
            }

            .btn-restart {
                padding: 10px 25px;
                font-size: 0.95em;
                margin-top: 15px;
            }

            .footer {
                padding: 8px 10px;
                font-size: 0.6em;
            }

            .footer p {
                margin: 1px 0;
            }

            .reset-btn {
                font-size: 0.6em;
                padding: 3px 8px;
            }

            .modal-content {
                padding: 20px 15px;
                max-width: 300px;
            }

            .modal-content h3 {
                font-size: 1.1em;
                margin-bottom: 15px;
            }

            .modal-content input {
                padding: 10px;
                font-size: 0.9em;
            }

            .modal-btn {
                padding: 8px 18px;
                font-size: 0.85em;
            }
        }

        /* Smartphones muito pequenos */
        @media screen and (max-width: 360px) {
            h1 {
                font-size: 1.3em;
            }

            .video-header {
                max-width: 100px;
            }

            .start-btn {
                width: 120px;
                height: 120px;
                font-size: 1em;
            }

            .start-btn::before {
                font-size: 1.2em;
                top: 10px;
            }

            .start-btn span {
                top: 18px;
            }

            .countdown-number {
                font-size: 5em;
            }

            .timer-display {
                font-size: 1.7em;
            }

            .word-display {
                font-size: 1.3em;
                padding: 20px 10px;
                min-height: 75px;
            }

            .stats {
                grid-template-columns: repeat(3, 1fr);
            }

            .stat-value {
                font-size: 1.3em;
            }

            .stat-label {
                font-size: 0.55em;
            }

            .final-score {
                font-size: 2em;
            }

            .ranking-list {
                max-height: 150px;
            }
        }

        /* Telas grandes e desktops */
        @media screen and (min-width: 1200px) {
            .container {
                max-width: 1000px;
                padding: 50px;
            }

            h1 {
                font-size: 3em;
            }

            .video-header {
                max-width: 200px;
            }

            .word-display {
                font-size: 4em;
                padding: 60px 50px;
            }

            .timer-display {
                font-size: 4em;
            }

            .stat-value {
                font-size: 2.5em;
            }
        }

        /* Modo paisagem em dispositivos m√≥veis */
        @media screen and (max-height: 500px) and (orientation: landscape) {
            body {
                align-items: flex-start;
                padding: 5px;
            }

            .container {
                padding: 15px 20px;
                margin-bottom: 70px;
            }

            h1 {
                font-size: 1.3em;
                margin-bottom: 5px;
            }

            .video-header {
                max-width: 80px;
                margin-bottom: 5px;
            }

            .start-btn {
                width: 100px;
                height: 100px;
                font-size: 0.9em;
            }

            .start-btn::before {
                font-size: 1em;
                top: 8px;
            }

            .start-btn span {
                top: 15px;
            }

            .register-screen {
                gap: 10px;
            }

            .countdown-number {
                font-size: 5em;
            }

            .timer-display {
                font-size: 1.8em;
                margin-bottom: 5px;
            }

            .word-display {
                font-size: clamp(1.2rem, 5vw, 1.6rem);
                padding: 15px 10px;
                min-height: 90px;
                margin-bottom: 8px;
            }

            .goal-indicator {
                font-size: 0.75em;
                padding: 4px 10px;
                margin-bottom: 5px;
            }

            .recording-indicator {
                font-size: 0.7em;
                margin-bottom: 5px;
            }

            .stats {
                gap: 5px;
                margin-top: 8px;
            }

            .stat-card {
                padding: 5px;
            }

            .stat-value {
                font-size: 1.2em;
            }

            .stat-label {
                font-size: 0.55em;
            }

            .footer {
                padding: 5px 10px;
                font-size: 0.55em;
            }

            .ranking-list {
                max-height: 100px;
            }
        }
    </style>
</head>
<body>
    <!-- Overlay para explos√£o em tela cheia -->
    <div id="explosionOverlay" class="explosion-overlay">
        <video id="explosionVideo" playsinline>
            <source src="bomba2.mp4" type="video/mp4">
        </video>
    </div>

    <div class="container">
        <h1>üí£ Leitura ou Bomba</h1>
        
        <!-- V√≠deo da bomba no cabe√ßalho -->
        <div id="videoHeader" class="video-header hidden">
            <video id="bgVideo" muted playsinline loop>
                <source src="bomba1.mp4" type="video/mp4">
            </video>
        </div>

        <!-- Tela de Cadastro -->
        <div id="registerScreen" class="register-screen">
            <p style="font-size: 1.2em; color: #7f8c8d;">Digite seu nome para come√ßar:</p>
            <input type="text" id="userName" placeholder="Seu nome" maxlength="30" autocomplete="off">
            <button id="startBtn" class="start-btn" onclick="startCountdown()" disabled>
                <span>INICIAR</span>
            </button>
            <p style="color: #e74c3c; font-size: 0.95em; margin-top: 10px;">
                ‚ö†Ô∏è Acerte <strong>10 palavras</strong> em cada fase para avan√ßar!
            </p>
            <div style="margin-top: 15px; font-size: 0.9em; color: #7f8c8d;">
                <p><strong>Fase 1:</strong> Palavras Reais</p>
                <p><strong>Fase 2:</strong> Pseudopalavras</p>
                <p><strong>Fase 3:</strong> Texto Completo</p>
            </div>
        </div>

        <!-- Contagem Regressiva (overlay) -->
        <div id="countdownOverlay" class="countdown-overlay hidden">
            <div id="countdownNumber" class="countdown-number">3</div>
        </div>

        <!-- Tela do Jogo -->
        <div id="gameScreen" class="game-screen">
            <p id="userGreeting" class="user-greeting"></p>
            <div id="timerDisplay" class="timer-display">01:00</div>
            
            <div id="phaseIndicator" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; padding: 8px 16px; border-radius: 20px; font-size: 1em; margin-bottom: 10px; display: inline-block;">
                üìñ Fase <span id="currentPhase">1</span>/3 - <span id="phaseType">Palavras Reais</span>
            </div>
            <div id="goalIndicator" class="goal-indicator">
                üéØ Meta: <span id="goalProgress">0</span>/10 palavras
            </div>
            
            <div class="word-timer-bar">
                <div id="wordTimerProgress" class="word-timer-progress"></div>
            </div>
            
            <div class="recording-indicator">
                <div class="recording-dot"></div>
                <span>Gravando... (3s por palavra)</span>
            </div>

            <div id="wordDisplay" class="word-display">
                Preparando...
            </div>

            <div id="result" class="result hidden"></div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="correctCount">0</div>
                    <div class="stat-label">‚úÖ Corretas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="incorrectCount">0</div>
                    <div class="stat-label">‚ùå Incorretas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalCount">0</div>
                    <div class="stat-label">üìä Total</div>
                </div>
            </div>
        </div>

        <!-- Tela de Resultados -->
        <div id="resultsScreen" class="results-screen">
            <h2 id="resultTitle" style="color: #e74c3c;">‚è∞ Tempo Esgotado!</h2>
            <p id="finalUserName" style="font-size: 1.3em; color: #7f8c8d; margin-top: 10px;"></p>
            <div class="final-score" id="finalScore">0</div>
            <p style="color: #7f8c8d;">palavras corretas</p>
            <p class="time-display" id="finalTime"></p>

            <h3 class="ranking-title">üèÜ Ranking - Top 10</h3>
            <ul id="rankingList" class="ranking-list"></ul>

            <button class="btn-restart" onclick="restartGame()">üîÑ Jogar Novamente</button>
        </div>
    </div>

    <!-- Modal de Senha para Reset -->
    <div id="resetModal" class="modal-overlay">
        <div class="modal-content">
            <h3>üîê √Årea Restrita</h3>
            <p style="color: #7f8c8d; margin-bottom: 15px;">Digite a senha para resetar o ranking:</p>
            <input type="password" id="resetPassword" placeholder="Senha" autocomplete="off">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeResetModal()">Cancelar</button>
                <button class="modal-btn confirm" onclick="confirmReset()">Confirmar</button>
            </div>
            <p id="resetError" class="modal-error">Senha incorreta!</p>
        </div>
    </div>

    <!-- Rodap√© -->
    <footer class="footer">
        <p class="author">Prof¬∫ Davi Antonino Nunes da Silva</p>
        <p>üìû (16) 99260-4315 | üìß davi.silva@educacao.sp.gov.br</p>
        <p class="usage">Para uso gratuito da Secretaria de Educa√ß√£o do Munic√≠pio de Sert√£ozinho</p>
        <button class="reset-btn" onclick="openResetModal()" title="√Årea administrativa">‚öôÔ∏è Admin</button>
    </footer>

    <script>
        // ===== CONFIGURA√á√ïES =====
        const WORD_TIME = 3000; // 3 segundos por palavra
        const GOAL_WORDS = 10; // Meta de palavras por fase
        const PHASE_TIME = 60; // 60 segundos por fase
        const TOTAL_PHASES = 3; // Total de fases
        const INTERIM_SIMILARITY_THRESHOLD = 80; // Dispara corre√ß√£o ainda durante a fala
        const FINAL_SIMILARITY_THRESHOLD = 65; // Precis√£o m√≠nima para considerar correto
        const MIN_SIMILARITY_TO_DISPLAY = 40; // Evita piscar com lixo sonoro
        const MAX_RECOGNITION_ALTERNATIVES = 20; // Mais alternativas para captar varia√ß√µes
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        // Texto completo para a Fase 3
        const textoFase3 = "O menino correu pelo parque enquanto o cachorro latia feliz. As flores coloridas balan√ßavam com o vento suave da tarde. A m√£e chamou as crian√ßas para merendar bolo de chocolate. Todos sentaram na varanda e conversaram sobre o dia na escola.";
        const palavrasTextoFase3 = textoFase3.split(/\s+/).map(p => p.replace(/[.,!?;:]/g, '').toLowerCase());

        // ===== PALAVRAS =====
        const palavrasReais = [
            "bala", "b√∫falo", "faca", "batata", "bula", "dourado", "fala",
            "ba√∫", "buzina", "do√ßura", "fada", "banana", "buda", "d√∫vida", "favela",
            "banco", "casa", "duelo", "ferida", "beb√™", "caneta", "feij√£o",
            "bebida", "cama", "d√∫zia", "besouro", "cadeado", "dureza", "fera",
            "bexiga", "calo", "festa", "fivela", "bico", "cebola", "transporte", "fita",
            "biruta", "cenoura", "filho", "figo", "bibel√¥", "cedo", "c√°rie", "fiado",
            "bife", "cera", "escola", "fil√≥", "bica", "cega", "terno", "fogo",
            "bola", "cidade", "futebol", "foca", "boca", "ex√©rcito", "fome",
            "bota", "cip√≥", "foto", "fobia", "bode", "futuro", "fub√°",
            "boneca", "coroa", "fuma√ßa", "fumo", "bule", "copo", "fugiu", "carta",
            "buraco", "cola", "comida", "janela", "couro", "amarelo", "couve",
            "lesma", "cu√≠ca", "garra", "cuba", "felino", "cubo", "correnteza", "cupido",
            "picada", "cuidado", "dinheiro", "dama", "barba", "dado", "jaula",
            "farelo", "data", "tosse", "dever", "jovem", "dedo",
            "selva", "feiti√ßo", "torta", "rosa", "del√≠cia", "demora",
            "chinelo", "dia", "inseto", "ditado", "grade",
            "meia", "acerola", "doce", "dona", "fam√≠lia",
            "fermento", "leite", "caderno", "machucado", "gola", "rede", "terra", "crian√ßa", "saxofone"
        ];

        const pseudoPalavras = [
            "belate", "cerebo", "tataba", "golamo", "baupi", "terrano", "dapeco",
            "bobelo", "calelo", "cenaba", "redela", "betouro", "gaxiba", "caraba",
            "bico√ßa", "cegeno", "rubita", "cirata", "belibo", "digano", "calipo",
            "nola", "cifroa", "futesa", "copico", "camanjo", "rotaba", "colena",
            "bodela", "necabo", "couroba", "burilo", "cartamo", "racubo", "cuip√≥",
            "jamelo", "fubalo", "cumalo", "almara", "lalubo", "cupado", "lesnaga",
            "zinama", "dudica", "garelho", "dadubo", "gradel", "fesona", "celapa",
            "meola", "colenga", "picamo", "caneto", "dinhelo", "didoba", "barfalo",
            "jaulare", "faretos", "delota", "tessenho", "jovenso", "tatado", "selva√ßo",
            "viba", "torrosa", "cocena", "chineto", "nanato", "insedro", "radona",
            "taxiglo", "sabaca", "duzima", "ternal", "brisote", "flumena", "grapefo",
            "plimoca", "drofila", "cranteba", "flosiga", "tremulo", "vaspino", "bruleca"
        ];

        const uniqueReais = [...new Set(palavrasReais)];
        const uniquePseudo = [...new Set(pseudoPalavras)];

        // ===== VARI√ÅVEIS GLOBAIS =====
        let currentWord = '';
        let currentPhase = 1; // Fase atual (1, 2 ou 3)
        let phaseStats = { correct: 0, incorrect: 0, total: 0 }; // Stats da fase atual
        let totalStats = { correct: 0, incorrect: 0, total: 0 }; // Stats totais do jogo
        let usedRealWords = [];
        let usedPseudoWords = [];
        let textoWordResults = []; // Resultados de valida√ß√£o: 'correct', 'incorrect', ou null
        let currentTextoWordIndex = 0; // √çndice da palavra atual no texto (fase 3)
        let recognition = null;
        let timerInterval = null;
        let wordTimerInterval = null;
        let timeRemaining = PHASE_TIME;
        let wordTimeRemaining = WORD_TIME;
        let userName = '';
        let gameStartTime = null;
        let gameEndTime = null;
        let wordAnswered = false;
        let isGameRunning = false;
        let recognitionRestarting = false;

        // ===== ELEMENTOS =====
        const bgVideo = document.getElementById('bgVideo');
        const explosionVideo = document.getElementById('explosionVideo');
        const videoHeader = document.getElementById('videoHeader');
        const explosionOverlay = document.getElementById('explosionOverlay');

        // ===== INICIALIZA√á√ÉO =====
        document.getElementById('userName').addEventListener('input', function() {
            document.getElementById('startBtn').disabled = this.value.trim().length < 2;
        });

        document.getElementById('userName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && this.value.trim().length >= 2) {
                startCountdown();
            }
        });

        // Inicializar Web Speech API
        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Seu navegador n√£o suporta reconhecimento de voz. Use Chrome ou Edge.');
                return false;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR';
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.maxAlternatives = MAX_RECOGNITION_ALTERNATIVES; // Mais alternativas para melhor precis√£o

            recognition.onresult = (event) => {
                if (!isGameRunning || wordAnswered) return;

                const normalizedExpected = normalizeText(currentWord);
                let bestTranscript = '';
                let bestSimilarity = 0;
                let bestConfidence = 0;
                let isFinalResult = false;

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    if (result.isFinal) isFinalResult = true;

                    for (let j = 0; j < result.length; j++) {
                        const alternative = result[j];
                        const transcript = alternative.transcript.toLowerCase().trim();
                        const confidence = alternative.confidence || 0;
                        const normalizedTranscript = normalizeText(transcript);

                        const words = normalizedTranscript.split(/\s+/);

                        for (const word of words) {
                            if (word.length < 2) continue;

                            const similarity = calculateSimilarity(
                                normalizedExpected,
                                word
                            );

                            const isBetter = similarity > bestSimilarity || (similarity === bestSimilarity && confidence > bestConfidence);
                            if (isBetter) {
                                bestSimilarity = similarity;
                                bestTranscript = word;
                                bestConfidence = confidence;
                            }
                        }

                        const fullSimilarity = calculateSimilarity(
                            normalizedExpected,
                            normalizedTranscript
                        );

                        const isBetterFull = fullSimilarity > bestSimilarity || (fullSimilarity === bestSimilarity && confidence > bestConfidence);
                        if (isBetterFull) {
                            bestSimilarity = fullSimilarity;
                            bestTranscript = transcript;
                            bestConfidence = confidence;
                        }
                    }
                }

                const hasInterimHit = bestTranscript && !isFinalResult && bestSimilarity >= INTERIM_SIMILARITY_THRESHOLD;
                const hasFinalHit = bestTranscript && isFinalResult && bestSimilarity >= FINAL_SIMILARITY_THRESHOLD;

                if (bestTranscript && !isFinalResult && bestSimilarity >= MIN_SIMILARITY_TO_DISPLAY) {
                    showInterimResult(bestTranscript, bestSimilarity);
                }

                if (hasInterimHit || hasFinalHit) {
                    wordAnswered = true;
                    clearWordTimer();
                    checkWord(bestTranscript);
                }
            };

            recognition.onerror = (event) => {
                console.log('Erro reconhecimento:', event.error);
                if (event.error === 'no-speech' || event.error === 'audio-capture' || event.error === 'network') {
                    // Tentar reiniciar
                    if (isGameRunning && !wordAnswered) {
                        setTimeout(() => {
                            if (isGameRunning && !wordAnswered) {
                                restartRecognition();
                            }
                        }, 200);
                    }
                }
            };

            recognition.onend = () => {
                console.log('Reconhecimento terminou, restarting:', recognitionRestarting);
                // Reiniciar automaticamente se o jogo ainda est√° rodando e n√£o foi parado intencionalmente
                if (isGameRunning && !wordAnswered && !recognitionRestarting) {
                    setTimeout(() => {
                        if (isGameRunning && !wordAnswered && !recognitionRestarting) {
                            restartRecognition();
                        }
                    }, 100);
                }
            };
            
            return true;
        }
        
        function restartRecognition() {
            if (!recognition || !isGameRunning || recognitionRestarting) return;
            try {
                recognition.stop();
            } catch(e) {}
            
            setTimeout(() => {
                if (isGameRunning && !wordAnswered && !recognitionRestarting) {
                    try {
                        recognition.start();
                        console.log('Reconhecimento reiniciado');
                    } catch(e) {
                        console.log('Erro ao reiniciar:', e);
                    }
                }
            }, 100);
        }
        
        // Inicializar reconhecimento de voz
        initSpeechRecognition();

        // ===== FUN√á√ïES =====
        function startCountdown() {
            userName = document.getElementById('userName').value.trim();
            if (userName.length < 2) return;

            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('countdownOverlay').classList.remove('hidden');

            let count = 3;
            const countdownEl = document.getElementById('countdownNumber');
            countdownEl.textContent = count;
            
            const countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownEl.textContent = count;
                    countdownEl.style.animation = 'none';
                    countdownEl.offsetHeight;
                    countdownEl.style.animation = 'countdownPulse 1s ease-in-out';
                } else if (count === 0) {
                    countdownEl.textContent = 'VAI!';
                    countdownEl.style.color = '#27ae60';
                    countdownEl.style.animation = 'none';
                    countdownEl.offsetHeight;
                    countdownEl.style.animation = 'countdownPulse 1s ease-in-out';
                } else {
                    clearInterval(countdownInterval);
                    countdownEl.style.color = '#e74c3c';
                    document.getElementById('countdownOverlay').classList.add('hidden');
                    startGame();
                }
            }, 1000);
        }

        function startGame() {
            currentPhase = 1;
            phaseStats = { correct: 0, incorrect: 0, total: 0 };
            totalStats = { correct: 0, incorrect: 0, total: 0 };
            usedRealWords = [];
            usedPseudoWords = [];
            textoWordResults = new Array(palavrasTextoFase3.length).fill(null);
            currentTextoWordIndex = 0;
            timeRemaining = PHASE_TIME;
            isGameRunning = true;
            gameStartTime = Date.now();
            recognitionRestarting = false;

            // Iniciar v√≠deo no cabe√ßalho
            videoHeader.classList.remove('hidden');
            bgVideo.currentTime = 0;
            bgVideo.loop = true;
            bgVideo.play().catch(e => console.log('Erro ao reproduzir v√≠deo:', e));

            document.getElementById('gameScreen').style.display = 'block';
            document.getElementById('userGreeting').textContent = `Jogador: ${userName}`;
            updateStats();
            updateGoalIndicator();
            updatePhaseIndicator();

            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                if (timeRemaining <= 0) {
                    endPhase(false); // Tempo esgotado na fase
                }
            }, 1000);

            getNextWord();
        }

        function updatePhaseIndicator() {
            document.getElementById('currentPhase').textContent = currentPhase;
            const phaseTypes = ['Palavras Reais', 'Pseudopalavras', 'Texto Completo'];
            document.getElementById('phaseType').textContent = phaseTypes[currentPhase - 1];
            
            // Atualizar cor do indicador de fase
            const phaseIndicator = document.getElementById('phaseIndicator');
            const colors = [
                'linear-gradient(135deg, #3498db, #2980b9)', // Fase 1 - Azul
                'linear-gradient(135deg, #9b59b6, #8e44ad)', // Fase 2 - Roxo
                'linear-gradient(135deg, #e74c3c, #c0392b)'  // Fase 3 - Vermelho
            ];
            phaseIndicator.style.background = colors[currentPhase - 1];
        }

        function startNextPhase() {
            currentPhase++;
            phaseStats = { correct: 0, incorrect: 0, total: 0 };
            timeRemaining = PHASE_TIME;
            
            if (currentPhase === 3) {
                currentTextoWordIndex = 0;
                textoWordResults = new Array(palavrasTextoFase3.length).fill(null);
            }
            
            updatePhaseIndicator();
            updateGoalIndicator();
            updateStats();
            
            // Mostrar transi√ß√£o de fase
            showPhaseTransition();
        }

        function showPhaseTransition() {
            stopRecognition();
            clearWordTimer();
            clearInterval(timerInterval);
            
            const phaseNames = ['Palavras Reais', 'Pseudopalavras', 'Texto Completo'];
            const wordDisplay = document.getElementById('wordDisplay');
            wordDisplay.innerHTML = `üéâ Fase ${currentPhase - 1} conclu√≠da!<br><br>Pr√≥xima: ${phaseNames[currentPhase - 1]}`;
            wordDisplay.style.fontSize = 'clamp(1.5rem, 4vw, 2.5rem)';
            
            setTimeout(() => {
                wordDisplay.style.fontSize = '';
                
                // Reiniciar timer da fase
                timerInterval = setInterval(() => {
                    timeRemaining--;
                    updateTimerDisplay();
                    if (timeRemaining <= 0) {
                        endPhase(false);
                    }
                }, 1000);
                
                getNextWord();
            }, 2000);
        }

        function endPhase(success) {
            if (!success) {
                // Falhou na fase - fim de jogo
                endGame();
                return;
            }
            
            // Passou na fase
            if (currentPhase < TOTAL_PHASES) {
                startNextPhase();
            } else {
                // Completou todas as fases!
                endGame();
            }
        }

        function startRecognitionForWord() {
            if (!recognition || !isGameRunning) return;
            
            // Resetar flag para permitir novo reconhecimento
            recognitionRestarting = false;
            
            try {
                recognition.start();
                console.log('Reconhecimento iniciado');
            } catch(e) {
                // J√° est√° rodando, ok
                console.log('Reconhecimento j√° est√° ativo');
            }
        }

        function stopRecognition() {
            if (!recognition) return;
            recognitionRestarting = true; // Impede restart autom√°tico
            try {
                recognition.stop();
                console.log('Reconhecimento parado');
            } catch(e) {}
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const timerEl = document.getElementById('timerDisplay');
            timerEl.textContent = display;
            
            timerEl.classList.remove('warning', 'danger');
            if (timeRemaining <= 10) {
                timerEl.classList.add('danger');
            } else if (timeRemaining <= 30) {
                timerEl.classList.add('warning');
            }
        }

        function updateGoalIndicator() {
            const indicator = document.getElementById('goalIndicator');
            const progress = document.getElementById('goalProgress');
            progress.textContent = phaseStats.correct;
            
            if (phaseStats.correct >= GOAL_WORDS) {
                indicator.classList.add('achieved');
                indicator.innerHTML = `‚úÖ Meta atingida! <span id="goalProgress">${phaseStats.correct}</span>/${GOAL_WORDS} palavras`;
            } else {
                indicator.classList.remove('achieved');
            }
        }

        function startWordTimer() {
            wordTimeRemaining = WORD_TIME;
            wordAnswered = false;
            
            const progressBar = document.getElementById('wordTimerProgress');
            progressBar.style.width = '100%';
            
            const startTime = Date.now();
            
            wordTimerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const remaining = WORD_TIME - elapsed;
                const percentage = (remaining / WORD_TIME) * 100;
                
                progressBar.style.width = Math.max(0, percentage) + '%';
                
                if (remaining <= 0) {
                    clearWordTimer();
                    if (!wordAnswered && isGameRunning) {
                        // Tempo esgotado para esta palavra - conta como erro
                        wordAnswered = true;
                        stopRecognition();
                        phaseStats.incorrect++;
                        phaseStats.total++;
                        totalStats.incorrect++;
                        totalStats.total++;
                        showResult(`‚è±Ô∏è Tempo esgotado! Esperado: ${currentWord}`, 'error');
                        updateStats();
                        
                        // Na fase 3, marcar como incorreto e atualizar visualiza√ß√£o
                        if (currentPhase === 3) {
                            textoWordResults[currentTextoWordIndex] = 'incorrect';
                            currentTextoWordIndex++;
                            renderTextoFase3();
                        }
                        
                        setTimeout(getNextWord, 500);
                    }
                }
            }, 50);

            // Iniciar reconhecimento
            startRecognitionForWord();
        }

        function clearWordTimer() {
            if (wordTimerInterval) {
                clearInterval(wordTimerInterval);
                wordTimerInterval = null;
            }
        }

        function getNextWord() {
            if (!isGameRunning) return;
            
            // Verificar se atingiu a meta da fase
            if (phaseStats.correct >= GOAL_WORDS) {
                endPhase(true);
                return;
            }
            
            stopRecognition();
            clearWordTimer();
            
            const wordDisplay = document.getElementById('wordDisplay');
            
            if (currentPhase === 1) {
                // Fase 1: Palavras Reais
                let wordList = uniqueReais.filter(w => !usedRealWords.includes(w));
                if (wordList.length === 0) {
                    usedRealWords = [];
                    wordList = uniqueReais;
                }
                currentWord = wordList[Math.floor(Math.random() * wordList.length)];
                usedRealWords.push(currentWord);
                wordDisplay.textContent = currentWord.toUpperCase();
                wordDisplay.style.fontSize = '';
                
            } else if (currentPhase === 2) {
                // Fase 2: Pseudopalavras
                let wordList = uniquePseudo.filter(w => !usedPseudoWords.includes(w));
                if (wordList.length === 0) {
                    usedPseudoWords = [];
                    wordList = uniquePseudo;
                }
                currentWord = wordList[Math.floor(Math.random() * wordList.length)];
                usedPseudoWords.push(currentWord);
                wordDisplay.textContent = currentWord.toUpperCase();
                wordDisplay.style.fontSize = '';
                
            } else if (currentPhase === 3) {
                // Fase 3: Texto Completo - mostrar texto inteiro e destacar palavra atual
                if (currentTextoWordIndex >= palavrasTextoFase3.length) {
                    currentTextoWordIndex = 0; // Reiniciar se acabar
                }
                currentWord = palavrasTextoFase3[currentTextoWordIndex];
                
                // Renderizar texto com palavra atual destacada
                renderTextoFase3();
            }

            document.getElementById('result').classList.add('hidden');
            
            // Iniciar timer de 3 segundos para esta palavra
            setTimeout(() => {
                if (isGameRunning) {
                    startWordTimer();
                }
            }, 100);
        }

        function renderTextoFase3() {
            const wordDisplay = document.getElementById('wordDisplay');
            wordDisplay.style.fontSize = 'clamp(1.1rem, 2.5vw, 1.6rem)';
            wordDisplay.style.textAlign = 'justify';
            wordDisplay.style.lineHeight = '2.2';
            wordDisplay.style.padding = '30px 40px';
            wordDisplay.style.textTransform = 'none';
            wordDisplay.style.letterSpacing = '0.5px';
            
            let html = '';
            const palavras = textoFase3.split(/\s+/);
            
            for (let i = 0; i < palavras.length; i++) {
                const palavra = palavras[i];
                
                if (i === currentTextoWordIndex) {
                    // Palavra atual - destacar em amarelo com borda
                    html += `<span style="background: #f1c40f; color: #000; padding: 4px 8px; border-radius: 6px; font-weight: bold; box-shadow: 0 2px 8px rgba(241,196,15,0.5);">${palavra}</span> `;
                } else if (textoWordResults[i] === 'correct') {
                    // Palavra lida corretamente - verde
                    html += `<span style="color: #27ae60; font-weight: 600;">${palavra}</span> `;
                } else if (textoWordResults[i] === 'incorrect') {
                    // Palavra lida incorretamente - vermelho com tachado
                    html += `<span style="color: #e74c3c; text-decoration: line-through; font-weight: 500;">${palavra}</span> `;
                } else {
                    // Palavra ainda n√£o lida - cor normal
                    html += `<span style="color: rgba(255,255,255,0.85);">${palavra}</span> `;
                }
            }
            
            wordDisplay.innerHTML = html;
        }

        function normalizeText(text) {
            text = text.toLowerCase().trim();
            // Remover pontua√ß√£o e caracteres especiais
            text = text.replace(/[.,!?;:'"()\-_]/g, '');
            // Remover espa√ßos extras
            text = text.replace(/\s+/g, ' ').trim();
            
            // Substitui√ß√µes de acentos
            const replacements = {
                '√°': 'a', '√†': 'a', '√£': 'a', '√¢': 'a', '√§': 'a',
                '√©': 'e', '√™': 'e', '√´': 'e', '√®': 'e',
                '√≠': 'i', '√Ø': 'i', '√¨': 'i',
                '√≥': 'o', '√¥': 'o', '√µ': 'o', '√∂': 'o', '√≤': 'o',
                '√∫': 'u', '√º': 'u', '√π': 'u',
                '√ß': 'c', '√±': 'n'
            };
            for (let [old, newChar] of Object.entries(replacements)) {
                text = text.replace(new RegExp(old, 'g'), newChar);
            }
            
            // Corre√ß√µes fon√©ticas comuns em portugu√™s brasileiro
            // Sons similares que o reconhecimento pode confundir
            text = text.replace(/ss/g, 's');
            text = text.replace(/rr/g, 'r');
            text = text.replace(/ll/g, 'l');
            text = text.replace(/nn/g, 'n');
            text = text.replace(/mm/g, 'm');
            text = text.replace(/x/g, 's'); // x pode soar como s
            text = text.replace(/ch/g, 'x'); // ch soa como x
            text = text.replace(/lh/g, 'li'); // lh pode ser ouvido como li
            text = text.replace(/nh/g, 'ni'); // nh pode ser ouvido como ni
            
            return text;
        }

        function calculateSimilarity(s1, s2) {
            const longer = s1.length > s2.length ? s1 : s2;
            const shorter = s1.length > s2.length ? s2 : s1;
            if (longer.length === 0) return 100;
            const editDistance = getEditDistance(longer, shorter);
            return Math.round((1 - editDistance / longer.length) * 100);
        }

        function getEditDistance(s1, s2) {
            s1 = s1.toLowerCase();
            s2 = s2.toLowerCase();
            const costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i === 0) {
                        costs[j] = j;
                    } else if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        }
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        }

        function checkWord(spokenWord) {
            if (!isGameRunning) return;
            
            const expected = normalizeText(currentWord);
            const spoken = normalizeText(spokenWord);
            const similarity = calculateSimilarity(expected, spoken);
            const isCorrect = similarity >= FINAL_SIMILARITY_THRESHOLD;
            
            if (isCorrect) {
                phaseStats.correct++;
                totalStats.correct++;
                showResult(`‚úÖ "${spokenWord}" (${similarity}%)`, 'success');
                
                // Na fase 3, marcar palavra como correta e atualizar visualiza√ß√£o
                if (currentPhase === 3) {
                    textoWordResults[currentTextoWordIndex] = 'correct';
                    currentTextoWordIndex++;
                    renderTextoFase3(); // Atualizar texto em tempo real
                }
            } else {
                phaseStats.incorrect++;
                totalStats.incorrect++;
                showResult(`‚ùå "${spokenWord}" (${similarity}%) - Esperado: ${currentWord}`, 'error');
                
                // Na fase 3, marcar palavra como incorreta e avan√ßar
                if (currentPhase === 3) {
                    textoWordResults[currentTextoWordIndex] = 'incorrect';
                    currentTextoWordIndex++;
                    renderTextoFase3(); // Atualizar texto em tempo real
                }
            }

            phaseStats.total++;
            totalStats.total++;
            updateStats();
            updateGoalIndicator();
            
            setTimeout(() => {
                if (isGameRunning) {
                    getNextWord();
                }
            }, 600);
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = message;
            resultDiv.classList.remove('hidden');
        }
        
        function showInterimResult(transcript, similarity) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'result interim';
            const simText = similarity ? ` (${similarity}%)` : '';
            resultDiv.innerHTML = `üéôÔ∏è "${transcript}"${simText}...`;
            resultDiv.classList.remove('hidden');
        }

        function updateStats() {
            document.getElementById('correctCount').textContent = phaseStats.correct;
            document.getElementById('incorrectCount').textContent = phaseStats.incorrect;
            document.getElementById('totalCount').textContent = phaseStats.total;
        }

        function endGame() {
            isGameRunning = false;
            gameEndTime = Date.now();
            
            clearInterval(timerInterval);
            timerInterval = null;
            clearWordTimer();
            stopRecognition();
            
            // Parar v√≠deo do cabe√ßalho
            bgVideo.pause();
            videoHeader.classList.add('hidden');

            const timeUsed = Math.round((gameEndTime - gameStartTime) / 1000);
            // Sucesso = completou todas as 3 fases
            const success = currentPhase === TOTAL_PHASES && phaseStats.correct >= GOAL_WORDS;

            if (!success) {
                // Mostrar explos√£o em tela cheia a partir dos 8 segundos
                explosionOverlay.classList.add('active');
                explosionVideo.currentTime = 8;
                explosionVideo.play().catch(e => console.log('Erro v√≠deo explos√£o:', e));
                
                explosionVideo.onended = () => {
                    explosionOverlay.classList.remove('active');
                    showResults(timeUsed, success);
                };
                
                setTimeout(() => {
                    if (explosionOverlay.classList.contains('active')) {
                        explosionOverlay.classList.remove('active');
                        showResults(timeUsed, success);
                    }
                }, 30000);
            } else {
                showResults(timeUsed, success);
            }
        }

        function showResults(timeUsed, success) {
            saveToRanking(userName, totalStats.correct, timeUsed);

            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('resultsScreen').style.display = 'block';
            
            const titleEl = document.getElementById('resultTitle');
            const scoreEl = document.getElementById('finalScore');
            
            if (success) {
                titleEl.textContent = 'üéâ Parab√©ns! Voc√™ completou todas as fases!';
                titleEl.style.color = '#27ae60';
                scoreEl.className = 'final-score success';
            } else {
                titleEl.innerHTML = `üí• BOOM! A bomba explodiu na Fase ${currentPhase}!`;
                titleEl.style.color = '#e74c3c';
                scoreEl.className = 'final-score fail';
            }
            
            document.getElementById('finalUserName').textContent = `Jogador: ${userName}`;
            document.getElementById('finalScore').textContent = totalStats.correct;
            
            const minutes = Math.floor(timeUsed / 60);
            const seconds = timeUsed % 60;
            document.getElementById('finalTime').textContent = 
                `Tempo: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} | Fases: ${success ? '3/3' : (currentPhase - 1) + '/3'}`;

            displayRanking();
        }

        function saveToRanking(name, score, time) {
            let ranking = JSON.parse(localStorage.getItem('leituraOuBombaRanking') || '[]');
            ranking.push({
                name: name,
                score: score,
                time: time,
                date: new Date().toLocaleDateString('pt-BR')
            });
            
            // Ordenar: mais palavras primeiro, depois menor tempo
            ranking.sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return (a.time || 999) - (b.time || 999);
            });
            
            ranking = ranking.slice(0, 10); // Top 10
            localStorage.setItem('leituraOuBombaRanking', JSON.stringify(ranking));
            
            // Tentar salvar no servidor
            if (!isLocalhost) {
                fetch('/api/ranking', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, score, time })
                }).catch(err => console.log('Erro ao salvar no servidor:', err));
            }
        }

        function displayRanking() {
            const ranking = JSON.parse(localStorage.getItem('leituraOuBombaRanking') || '[]');
            const listEl = document.getElementById('rankingList');
            listEl.innerHTML = '';

            ranking.slice(0, 10).forEach((entry, index) => {
                const li = document.createElement('li');
                li.className = 'ranking-item';
                
                if (index === 0) li.classList.add('gold');
                else if (index === 1) li.classList.add('silver');
                else if (index === 2) li.classList.add('bronze');

                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}¬∫`;
                
                const timeMinutes = Math.floor((entry.time || 0) / 60);
                const timeSeconds = (entry.time || 0) % 60;
                const timeStr = `${timeMinutes}:${timeSeconds.toString().padStart(2, '0')}`;

                li.innerHTML = `
                    <span class="ranking-position">${medal}</span>
                    <span class="ranking-name">${entry.name}</span>
                    <div class="ranking-info">
                        <div class="ranking-score">${entry.score} ‚úÖ</div>
                        <div class="ranking-time">‚è±Ô∏è ${timeStr}</div>
                    </div>
                `;
                listEl.appendChild(li);
            });

            if (ranking.length === 0) {
                listEl.innerHTML = '<li class="ranking-item">Nenhum registro ainda</li>';
            }
        }
        
        // ===== FUN√á√ïES DO MODAL DE RESET =====
        function openResetModal() {
            document.getElementById('resetModal').classList.add('active');
            document.getElementById('resetPassword').value = '';
            document.getElementById('resetError').style.display = 'none';
            document.getElementById('resetPassword').focus();
        }
        
        function closeResetModal() {
            document.getElementById('resetModal').classList.remove('active');
        }
        
        function confirmReset() {
            const password = document.getElementById('resetPassword').value;
            
            if (password === 'Camila') {
                localStorage.removeItem('leituraOuBombaRanking');
                
                if (!isLocalhost) {
                    fetch('/api/ranking', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    }).catch(err => console.log('Erro ao resetar no servidor:', err));
                }
                
                closeResetModal();
                alert('‚úÖ Ranking resetado com sucesso!');
                displayRanking();
            } else {
                document.getElementById('resetError').style.display = 'block';
                document.getElementById('resetPassword').value = '';
                document.getElementById('resetPassword').focus();
            }
        }
        
        document.getElementById('resetPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') confirmReset();
        });
        
        document.getElementById('resetModal').addEventListener('click', function(e) {
            if (e.target === this) closeResetModal();
        });

        function restartGame() {
            document.getElementById('resultsScreen').style.display = 'none';
            document.getElementById('registerScreen').classList.remove('hidden');
            document.getElementById('userName').value = '';
            document.getElementById('startBtn').disabled = true;
            document.getElementById('result').classList.add('hidden');
            
            // Resetar indicador de meta
            const indicator = document.getElementById('goalIndicator');
            indicator.classList.remove('achieved');
            indicator.innerHTML = `üéØ Meta: <span id="goalProgress">0</span>/${GOAL_WORDS} palavras`;
            
            // Resetar indicador de fase
            document.getElementById('currentPhase').textContent = '1';
            document.getElementById('phaseType').textContent = 'Palavras Reais';
            
            // Resetar estilo do word display completamente
            const wordDisplay = document.getElementById('wordDisplay');
            wordDisplay.style.fontSize = '';
            wordDisplay.style.textAlign = '';
            wordDisplay.style.lineHeight = '';
            wordDisplay.style.padding = '';
            wordDisplay.style.textTransform = '';
            wordDisplay.style.letterSpacing = '';
            wordDisplay.textContent = 'Preparando...';
        }
    </script>
</body>
</html>
